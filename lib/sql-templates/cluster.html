<html>
<body>
<script id="cluster_template" type="sql/html">
WITH metatile_extent AS (
  SELECT ST_SetSRID(!bbox!::box3d, 3857) as ext
),
filtered_table AS (
  SELECT t.* FROM {{table}} t, metatile_extent m WHERE t.geometry && m.ext
),
hgridA AS (SELECT CDB_HexagonGrid(ST_Expand(!bbox!, greatest(!pixel_width!,!pixel_height!) * 48), greatest(!pixel_width!,!pixel_height!) * 48) as cell),
bigs AS (SELECT * FROM (SELECT ST_Centroid(ST_Collect(i.geometry)) as geometry, count(i.id) as points_count, 1 as id, array_agg(id) AS id_list FROM hgridA, filtered_table i where ST_Intersects(i.geometry, hgridA.cell) GROUP BY hgridA.cell) t WHERE points_count > 2*48 ),
hgridB AS (SELECT CDB_HexagonGrid(ST_Expand(!bbox!, greatest(!pixel_width!,!pixel_height!) * 0.75*48), greatest(!pixel_width!,!pixel_height!) * 0.75*48) as cell),
mids AS (SELECT * FROM (SELECT ST_Centroid(ST_Collect(i.geometry)) as geometry, count(i.id) as points_count, 1 as id, array_agg(id) AS id_list FROM hgridB, filtered_table i where ST_Intersects(i.geometry, hgridB.cell) AND id NOT IN (SELECT unnest(id_list) FROM bigs) GROUP BY hgridB.cell) t WHERE points_count > 0.5*48 ),
hgridC AS (SELECT CDB_HexagonGrid(ST_Expand(!bbox!, greatest(!pixel_width!,!pixel_height!) * 24), greatest(!pixel_width!,!pixel_height!) * 0.5*48) as cell),
smalls AS (SELECT * FROM (SELECT ST_Centroid(ST_Collect(i.geometry)) as geometry, count(i.id) as points_count, 1 as id, array_agg(id) AS id_list FROM hgridC, filtered_table i where ST_Intersects(i.geometry, hgridC.cell) AND id NOT IN (SELECT unnest(id_list) FROM bigs) AND id NOT IN (SELECT unnest(id_list) FROM mids) GROUP BY hgridC.cell) t WHERE points_count > GREATEST(0.1*48, 2) )
SELECT geometry, 1 points_count, id, ARRAY[id] as id_list, 'origin' as src, id::text cdb_list FROM filtered_table WHERE id NOT IN (select unnest(id_list) FROM bigs) AND id NOT IN (select unnest(id_list) FROM mids) AND id NOT IN (select unnest(id_list) FROM smalls)
UNION ALL
SELECT *, 'bigs' as src, array_to_string(id_list, ',') FROM bigs
UNION ALL
SELECT *, 'mids' as src, array_to_string(id_list, ',') FROM mids
UNION ALL
SELECT *, 'smalls' as src, array_to_string(id_list, ',') FROM smalls
</script>
</body>
</html>
